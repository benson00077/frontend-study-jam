## ç¬¬ 16 ç« 

### çŠ¶æ€æ¨¡å¼

çŠ¶æ€æ¨¡å¼æ˜¯ä¸€ç§éåŒå¯»å¸¸çš„ä¼˜ç§€æ¨¡å¼ï¼Œå®ƒä¹Ÿè®¸æ˜¯è§£å†³æŸäº›éœ€æ±‚åœºæ™¯çš„æœ€å¥½æ–¹æ³•ã€‚è™½ç„¶çŠ¶æ€æ¨¡å¼å¹¶ä¸æ˜¯ä¸€ç§ç®€å•åˆ°ä¸€ç›®äº†ç„¶çš„æ¨¡å¼ï¼ˆå®ƒå¾€å¾€è¿˜ä¼šå¸¦æ¥ä»£ç é‡çš„å¢åŠ ï¼‰ï¼Œä½†ä½ ä¸€æ—¦æ˜ç™½äº†çŠ¶æ€æ¨¡å¼çš„ç²¾é«“ï¼Œä»¥åä¸€å®šä¼šæ„Ÿè°¢å®ƒå¸¦ç»™ä½ çš„æ— ä¸ä¼¦æ¯”çš„å¥½å¤„ã€‚

çŠ¶æ€æ¨¡å¼çš„å…³é”®æ˜¯åŒºåˆ†äº‹ç‰©å†…éƒ¨çš„çŠ¶æ€ï¼Œäº‹ç‰©å†…éƒ¨çŠ¶æ€çš„æ”¹å˜å¾€å¾€ä¼šå¸¦æ¥äº‹ç‰©çš„è¡Œä¸ºæ”¹å˜ã€‚

### 16.1 åˆè¯†çŠ¶æ€æ¨¡å¼

æˆ‘ä»¬æ¥æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šæœ‰ä¸€ä¸ªç”µç¯ï¼Œç”µç¯ä¸Šé¢åªæœ‰ä¸€ä¸ªå¼€å…³ã€‚å½“ç”µç¯å¼€ç€çš„æ—¶å€™ï¼Œæ­¤æ—¶æŒ‰ä¸‹å¼€å…³ï¼Œç”µç¯ä¼šåˆ‡æ¢åˆ°å…³é—­çŠ¶æ€ï¼›å†æŒ‰ä¸€æ¬¡å¼€å…³ï¼Œç”µç¯åˆå°†è¢«æ‰“å¼€ã€‚åŒä¸€ä¸ªå¼€å…³æŒ‰é’®ï¼Œåœ¨ä¸åŒçš„çŠ¶æ€ä¸‹ï¼Œè¡¨ç°å‡ºæ¥çš„è¡Œä¸ºæ˜¯ä¸ä¸€æ ·çš„ã€‚

ç°åœ¨ç”¨ä»£ç æ¥æè¿°è¿™ä¸ªåœºæ™¯ï¼Œé¦–å…ˆå®šä¹‰ä¸€ä¸ª Light ç±»ï¼Œå¯ä»¥é¢„è§ï¼Œç”µç¯å¯¹è±¡ light å°†ä» Light ç±»åˆ›å»ºè€Œå‡ºï¼Œ light å¯¹è±¡å°†æ‹¥æœ‰ä¸¤ä¸ªå±æ€§ï¼Œæˆ‘ä»¬ç”¨ state æ¥è®°å½•ç”µç¯å½“å‰çš„çŠ¶æ€ï¼Œç”¨ button è¡¨ç¤ºå…·ä½“çš„å¼€å…³æŒ‰é’®ã€‚ä¸‹é¢æ¥ç¼–å†™è¿™ä¸ªç”µç¯ç¨‹åºçš„ä¾‹å­ã€‚

#### 16.1.1 ç¬¬ä¸€ä¸ªä¾‹å­ï¼šç”µç¯ç¨‹åº

é¦–å…ˆç»™å‡ºä¸ç”¨çŠ¶æ€æ¨¡å¼çš„ç”µç¯ç¨‹åºå®ç°ï¼š

```js
var Light = function () {
  this.state = "off"; // ç»™ç”µç¯è®¾ç½®åˆå§‹çŠ¶æ€off
  this.button = null; // ç”µç¯å¼€å…³æŒ‰é’®
};
```

æ¥ä¸‹æ¥å®šä¹‰ Light.prototype.init æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è´Ÿè´£åœ¨é¡µé¢ä¸­åˆ›å»ºä¸€ä¸ªçœŸå®çš„ button èŠ‚ç‚¹ï¼Œå‡è®¾è¿™ä¸ª button å°±æ˜¯ç”µç¯çš„å¼€å…³æŒ‰é’®ï¼Œå½“ button çš„ onclick äº‹ä»¶è¢«è§¦å‘æ—¶ï¼Œå°±æ˜¯ç”µç¯å¼€å…³è¢«æŒ‰ä¸‹çš„æ—¶å€™ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
Light.prototype.init = function () {
  var button = document.createElement("button"),
    self = this;
  button.innerHTML = "å¼€å…³";
  this.button = document.body.appendChild(button);
  this.button.onclick = function () {
    self.buttonWasPressed();
  };
};
```

å½“å¼€å…³è¢«æŒ‰ä¸‹æ—¶ï¼Œç¨‹åºä¼šè°ƒç”¨ self.buttonWasPressed æ–¹æ³•ï¼Œ å¼€å…³æŒ‰ä¸‹ä¹‹åçš„æ‰€æœ‰è¡Œä¸ºï¼Œéƒ½å°†è¢«å°è£…åœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
Light.prototype.buttonWasPressed = function () {
  if (this.state === "off") {
    console.log("å¼€ç¯");
    this.state = "on";
  } else if (this.state === "on") {
    console.log("å…³ç¯");
    this.state = "off";
  }
};
var light = new Light();
light.init();
```

OKï¼Œç°åœ¨å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»ç¼–å†™äº†ä¸€ä¸ªå¼ºå£®çš„çŠ¶æ€æœºï¼Œè¿™ä¸ªçŠ¶æ€æœºçš„é€»è¾‘æ—¢ç®€å•åˆç¼œå¯†ï¼Œçœ‹èµ·æ¥è¿™æ®µä»£ç è®¾è®¡å¾—æ— æ‡ˆå¯å‡»ï¼Œè¿™ä¸ªç¨‹åºæ²¡æœ‰ä»»ä½• bugã€‚å®é™…ä¸Šè¿™ç§ä»£ç æˆ‘ä»¬å·²ç»ç¼–å†™è¿‡æ— æ•°éï¼Œæ¯”å¦‚è¦äº¤æ›¿åˆ‡æ¢ä¸€ä¸ª button çš„ classï¼Œè·Ÿæ­¤ä¾‹ä¸€æ ·ï¼Œå¾€å¾€å…ˆç”¨ä¸€ä¸ªå˜é‡ state æ¥è®°å½•æŒ‰é’®çš„å½“å‰çŠ¶æ€ï¼Œåœ¨äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå†æ ¹æ®è¿™ä¸ªçŠ¶æ€æ¥å†³å®šä¸‹ä¸€æ­¥çš„è¡Œä¸ºã€‚

ä»¤äººé—æ†¾çš„æ˜¯ï¼Œè¿™ä¸ªä¸–ç•Œä¸Šçš„ç”µç¯å¹¶éåªæœ‰ä¸€ç§ã€‚è®¸å¤šé…’åº—é‡Œæœ‰å¦å¤–ä¸€ç§ç”µç¯ï¼Œè¿™ç§ç”µç¯ä¹Ÿåªæœ‰ä¸€ä¸ªå¼€å…³ï¼Œä½†å®ƒçš„è¡¨ç°æ˜¯ï¼šç¬¬ä¸€æ¬¡æŒ‰ä¸‹æ‰“å¼€å¼±å…‰ï¼Œç¬¬äºŒæ¬¡æŒ‰ä¸‹æ‰“å¼€å¼ºå…‰ï¼Œç¬¬ä¸‰æ¬¡æ‰æ˜¯å…³é—­ç”µç¯ã€‚ç°åœ¨å¿…é¡»æ”¹é€ ä¸Šé¢çš„ä»£ç æ¥å®Œæˆè¿™ç§æ–°å‹ç”µç¯çš„åˆ¶é€ ï¼š

```js
Light.prototype.buttonWasPressed = function () {
  if (this.state === "off") {
    console.log("å¼±å…‰");
    this.state = "weakLight";
  } else if (this.state === "weakLight") {
    console.log("å¼ºå…‰");
    this.state = "strongLight";
  } else if (this.state === "strongLight") {
    console.log("å…³ç¯");
    this.state = "off";
  }
};
```

ç°åœ¨è¿™ä¸ªåä¾‹å…ˆå‘Šä¸€æ®µè½ï¼Œæˆ‘ä»¬æ¥è€ƒè™‘ä¸€ä¸‹ä¸Šè¿°ç¨‹åºçš„ç¼ºç‚¹ã€‚

- ğŸ”º å¾ˆæ˜æ˜¾ buttonWasPressed æ–¹æ³•æ˜¯è¿åå¼€æ”¾â€”å°é—­åŸåˆ™çš„ï¼Œæ¯æ¬¡æ–°å¢æˆ–è€…ä¿®æ”¹ light çš„çŠ¶æ€ï¼Œéƒ½éœ€è¦æ”¹åŠ¨ buttonWasPressed æ–¹æ³•ä¸­çš„ä»£ç ï¼Œè¿™ä½¿å¾— buttonWasPressed æˆä¸ºäº†ä¸€ä¸ªéå¸¸ä¸ç¨³å®šçš„æ–¹æ³•ã€‚
- ğŸ”º æ‰€æœ‰è·ŸçŠ¶æ€æœ‰å…³çš„è¡Œä¸ºï¼Œéƒ½è¢«å°è£…åœ¨ buttonWasPressed æ–¹æ³•é‡Œï¼Œå¦‚æœä»¥åè¿™ä¸ªç”µç¯åˆå¢åŠ äº†å¼ºå¼ºå…‰ã€è¶…å¼ºå…‰å’Œç»ˆæå¼ºå…‰ï¼Œé‚£æˆ‘ä»¬å°†æ— æ³•é¢„è®¡è¿™ä¸ªæ–¹æ³•å°†è†¨èƒ€åˆ°ä»€ä¹ˆåœ°æ­¥ã€‚å½“ç„¶ä¸ºäº†ç®€åŒ–ç¤ºä¾‹ï¼Œæ­¤å¤„åœ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œåªæ˜¯ç®€å•åœ°æ‰“å°ä¸€æ¡ log å’Œæ”¹å˜ button çš„ innerHTMLã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¦å¤„ç†çš„äº‹æƒ…å¯èƒ½æ¯”è¿™å¤šå¾—å¤šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒuttonWasPressed æ–¹æ³•è¦æ¯”ç°åœ¨åºå¤§å¾—å¤šã€‚
- ğŸ”º çŠ¶æ€çš„åˆ‡æ¢éå¸¸ä¸æ˜æ˜¾ï¼Œä»…ä»…è¡¨ç°ä¸ºå¯¹ state å˜é‡èµ‹å€¼ï¼Œæ¯”å¦‚ this.state = 'weakLight'ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿™æ ·çš„æ“ä½œå¾ˆå®¹æ˜“è¢«ç¨‹åºå‘˜ä¸å°å¿ƒæ¼æ‰ã€‚æˆ‘ä»¬ä¹Ÿæ²¡æœ‰åŠæ³•ä¸€ç›®äº†ç„¶åœ°æ˜ç™½ç”µç¯ä¸€å…±æœ‰å¤šå°‘ç§çŠ¶æ€ï¼Œé™¤éè€å¿ƒåœ°è¯»å®Œ buttonWasPressed æ–¹æ³•é‡Œçš„æ‰€æœ‰ä»£ç ã€‚å½“çŠ¶æ€çš„ç§ç±»å¤šèµ·æ¥çš„æ—¶å€™ï¼ŒæŸä¸€æ¬¡åˆ‡æ¢çš„è¿‡ç¨‹å°±å¥½åƒè¢«åŸ‹è—åœ¨ä¸€ä¸ªå·¨å¤§æ–¹æ³•çš„æŸä¸ªé˜´æš—è§’è½é‡Œã€‚
- ğŸ”º çŠ¶æ€ä¹‹é—´çš„åˆ‡æ¢å…³ç³»ï¼Œä¸è¿‡æ˜¯å¾€ buttonWasPressed æ–¹æ³•é‡Œå †ç Œ ifã€else è¯­å¥ï¼Œå¢åŠ æˆ–è€…ä¿®æ”¹ä¸€ä¸ªçŠ¶æ€å¯èƒ½éœ€è¦æ”¹å˜è‹¥å¹²ä¸ªæ“ä½œï¼Œè¿™ä½¿ buttonWasPressed æ›´åŠ éš¾ä»¥é˜…è¯»å’Œç»´æŠ¤ã€‚

#### 16.1.2 çŠ¶æ€æ¨¡å¼æ”¹è¿›ç”µç¯ç¨‹åº

ç°åœ¨æˆ‘ä»¬å­¦ä¹ ä½¿ç”¨çŠ¶æ€æ¨¡å¼æ”¹è¿›ç”µç¯çš„ç¨‹åºã€‚æœ‰æ„æ€çš„æ˜¯ï¼Œé€šå¸¸æˆ‘ä»¬è°ˆåˆ°å°è£…ï¼Œä¸€èˆ¬éƒ½ä¼šä¼˜å…ˆå°è£…å¯¹è±¡çš„è¡Œä¸ºï¼Œè€Œä¸æ˜¯å¯¹è±¡çš„çŠ¶æ€ã€‚ä½†åœ¨çŠ¶æ€æ¨¡å¼ä¸­åˆšå¥½ç›¸åï¼ŒçŠ¶æ€æ¨¡å¼çš„å…³é”®æ˜¯æŠŠäº‹ç‰©çš„æ¯ç§çŠ¶æ€éƒ½å°è£…æˆå•ç‹¬çš„ç±»ï¼Œè·Ÿæ­¤ç§çŠ¶æ€æœ‰å…³çš„è¡Œä¸ºéƒ½è¢«å°è£…åœ¨è¿™ä¸ªç±»çš„å†…éƒ¨ï¼Œæ‰€ä»¥ button è¢«æŒ‰ä¸‹çš„çš„æ—¶å€™ï¼Œåªéœ€è¦åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼ŒæŠŠè¿™ä¸ªè¯·æ±‚å§”æ‰˜ç»™å½“å‰çš„çŠ¶æ€å¯¹è±¡å³å¯ï¼Œè¯¥çŠ¶æ€å¯¹è±¡ä¼šè´Ÿè´£æ¸²æŸ“å®ƒè‡ªèº«çš„è¡Œä¸ºï¼Œå¦‚å›¾ 16-1 æ‰€ç¤ºã€‚

å›¾ 16-1
åŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥æŠŠçŠ¶æ€çš„åˆ‡æ¢è§„åˆ™äº‹å…ˆåˆ†å¸ƒåœ¨çŠ¶æ€ç±»ä¸­ï¼Œ è¿™æ ·å°±æœ‰æ•ˆåœ°æ¶ˆé™¤äº†åŸæœ¬å­˜åœ¨çš„å¤§é‡æ¡ä»¶åˆ†æ”¯è¯­å¥ï¼Œå¦‚å›¾ 16-2 æ‰€ç¤ºã€‚

å›¾ 16-2
ä¸‹é¢è¿›å…¥çŠ¶æ€æ¨¡å¼çš„ä»£ç ç¼–å†™é˜¶æ®µï¼Œé¦–å…ˆå°†å®šä¹‰ 3 ä¸ªçŠ¶æ€ç±»ï¼Œåˆ†åˆ«æ˜¯ offLightStateã€WeakLightStateã€strongLightStateã€‚è¿™ 3 ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªåŸå‹æ–¹æ³• buttonWasPressedï¼Œä»£è¡¨åœ¨å„è‡ªçŠ¶æ€ä¸‹ï¼ŒæŒ‰é’®è¢«æŒ‰ä¸‹æ—¶å°†å‘ç”Ÿçš„è¡Œä¸ºï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
// OffLightStateï¼š
var OffLightState = function (light) {
  this.light = light;
};
OffLightState.prototype.buttonWasPressed = function () {
  console.log("å¼±å…‰"); // offLightStateå¯¹åº”çš„è¡Œä¸º
  this.light.setState(this.light.weakLightState); // åˆ‡æ¢çŠ¶æ€åˆ°weakLightState
};
// WeakLightStateï¼š
var WeakLightState = function (light) {
  this.light = light;
};
WeakLightState.prototype.buttonWasPressed = function () {
  console.log("å¼ºå…‰"); // weakLightStateå¯¹åº”çš„è¡Œä¸º
  this.light.setState(this.light.strongLightState); // åˆ‡æ¢çŠ¶æ€åˆ°strongLightState
};
// StrongLightStateï¼š
var StrongLightState = function (light) {
  this.light = light;
};
StrongLightState.prototype.buttonWasPressed = function () {
  console.log("å…³ç¯"); // strongLightStateå¯¹åº”çš„è¡Œä¸º
  this.light.setState(this.light.offLightState); // åˆ‡æ¢çŠ¶æ€åˆ°offLightState
};
```

æ¥ä¸‹æ¥æ”¹å†™ Light ç±»ï¼Œç°åœ¨ä¸å†ä½¿ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²æ¥è®°å½•å½“å‰çš„çŠ¶æ€ï¼Œè€Œæ˜¯ä½¿ç”¨æ›´åŠ ç«‹ä½“åŒ–çš„çŠ¶æ€å¯¹è±¡ã€‚æˆ‘ä»¬åœ¨ Light ç±»çš„æ„é€ å‡½æ•°é‡Œä¸ºæ¯ä¸ªçŠ¶æ€ç±»éƒ½åˆ›å»ºä¸€ä¸ªçŠ¶æ€å¯¹è±¡ï¼Œè¿™æ ·ä¸€æ¥æˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾åœ°çœ‹åˆ°ç”µç¯ä¸€å…±æœ‰å¤šå°‘ç§çŠ¶æ€ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
var Light = function () {
  this.offLightState = new OffLightState(this);
  this.weakLightState = new WeakLightState(this);
  this.strongLightState = new StrongLightState(this);
  this.button = null;
};
```

åœ¨ button æŒ‰é’®è¢«æŒ‰ä¸‹çš„äº‹ä»¶é‡Œï¼ŒContext ä¹Ÿä¸å†ç›´æ¥è¿›è¡Œä»»ä½•å®è´¨æ€§çš„æ“ä½œï¼Œè€Œæ˜¯é€šè¿‡ self.currState.buttonWasPressed()å°†è¯·æ±‚å§”æ‰˜ç»™å½“å‰æŒæœ‰çš„çŠ¶æ€å¯¹è±¡å»æ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
Light.prototype.init = function () {
  var button = document.createElement("button"),
    self = this;
  this.button = document.body.appendChild(button);
  this.button.innerHTML = "å¼€å…³";
  this.currState = this.offLightState; // è®¾ç½®å½“å‰çŠ¶æ€
  this.button.onclick = function () {
    self.currState.buttonWasPressed();
  };
};
```

æœ€åè¿˜è¦æä¾›ä¸€ä¸ª Light.prototype.setState æ–¹æ³•ï¼ŒçŠ¶æ€å¯¹è±¡å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥åˆ‡æ¢ light å¯¹è±¡çš„çŠ¶æ€ã€‚å‰é¢å·²ç»è¯´è¿‡ï¼ŒçŠ¶æ€çš„åˆ‡æ¢è§„å¾‹äº‹å…ˆè¢«å®Œå¥½å®šä¹‰åœ¨å„ä¸ªçŠ¶æ€ç±»ä¸­ã€‚åœ¨ Context ä¸­å†ä¹Ÿæ‰¾ä¸åˆ°ä»»ä½•ä¸€ä¸ªè·ŸçŠ¶æ€åˆ‡æ¢ç›¸å…³çš„æ¡ä»¶åˆ†æ”¯è¯­å¥ï¼š

```js
Light.prototype.setState = function (newState) {
  this.currState = newState;
};
```

ç°åœ¨å¯ä»¥è¿›è¡Œä¸€äº›æµ‹è¯•ï¼š

```js
var light = new Light();
light.init();
```

ä¸å‡ºæ„å¤–çš„è¯ï¼Œæ‰§è¡Œç»“æœè·Ÿä¹‹å‰çš„ä»£ç ä¸€è‡´ï¼Œä½†æ˜¯ä½¿ç”¨çŠ¶æ€æ¨¡å¼çš„å¥½å¤„å¾ˆæ˜æ˜¾ï¼Œå®ƒå¯ä»¥ä½¿æ¯ä¸€ç§çŠ¶æ€å’Œå®ƒå¯¹åº”çš„è¡Œä¸ºä¹‹é—´çš„å…³ç³»å±€éƒ¨åŒ–ï¼Œè¿™äº›è¡Œä¸ºè¢«åˆ†æ•£å’Œå°è£…åœ¨å„è‡ªå¯¹åº”çš„çŠ¶æ€ç±»ä¹‹ä¸­ï¼Œä¾¿äºé˜…è¯»å’Œç®¡ç†ä»£ç ã€‚

å¦å¤–ï¼ŒçŠ¶æ€ä¹‹é—´çš„åˆ‡æ¢éƒ½è¢«åˆ†å¸ƒåœ¨çŠ¶æ€ç±»å†…éƒ¨ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æ— éœ€ç¼–å†™è¿‡å¤šçš„ ifã€else æ¡ä»¶åˆ†æ”¯è¯­è¨€æ¥æ§åˆ¶çŠ¶æ€ä¹‹é—´çš„è½¬æ¢ã€‚

å½“æˆ‘ä»¬éœ€è¦ä¸º light å¯¹è±¡å¢åŠ ä¸€ç§æ–°çš„çŠ¶æ€æ—¶ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„çŠ¶æ€ç±»ï¼Œå†ç¨ç¨æ”¹å˜ä¸€äº›ç°æœ‰çš„ä»£ç å³å¯ã€‚å‡è®¾ç°åœ¨ light å¯¹è±¡å¤šäº†ä¸€ç§è¶…å¼ºå…‰çš„çŠ¶æ€ï¼Œé‚£å°±å…ˆå¢åŠ  SuperStrongLightState ç±»ï¼š

```js
var SuperStrongLightState = function (light) {
  this.light = light;
};
SuperStrongLightState.prototype.buttonWasPressed = function () {
  console.log("å…³ç¯");
  this.light.setState(this.light.offLightState);
};
```

ç„¶ååœ¨ Light æ„é€ å‡½æ•°é‡Œæ–°å¢ä¸€ä¸ª superStrongLightState å¯¹è±¡ï¼š

```js
var Light = function () {
  this.offLightState = new OffLightState(this);
  this.weakLightState = new WeakLightState(this);
  this.strongLightState = new StrongLightState(this);
  this.superStrongLightState = new SuperStrongLightState(this); // æ–°å¢superStrongLightStateå¯¹è±¡
  this.button = null;
};
```

æœ€åæ”¹å˜çŠ¶æ€ç±»ä¹‹é—´çš„åˆ‡æ¢è§„åˆ™ï¼Œä» StrongLightState---->OffLightState å˜ä¸º StrongLightState---->SuperStrongLightState ---->OffLightStateï¼š

```js
StrongLightState.prototype.buttonWasPressed = function () {
  console.log("è¶…å¼ºå…‰"); // strongLightStateå¯¹åº”çš„è¡Œä¸º
  this.light.setState(this.light.superStrongLightState); // åˆ‡æ¢çŠ¶æ€åˆ°offLightState
};
```

### 16.2 çŠ¶æ€æ¨¡å¼çš„å®šä¹‰

é€šè¿‡ç”µç¯çš„ä¾‹å­ï¼Œç›¸ä¿¡æˆ‘ä»¬å¯¹äºçŠ¶æ€æ¨¡å¼å·²ç»æœ‰äº†ä¸€å®šç¨‹åº¦çš„äº†è§£ã€‚ç°åœ¨å›å¤´æ¥çœ‹ GoF ä¸­å¯¹çŠ¶æ€æ¨¡å¼çš„å®šä¹‰ï¼š

å…è®¸ä¸€ä¸ªå¯¹è±¡åœ¨å…¶å†…éƒ¨çŠ¶æ€æ”¹å˜æ—¶æ”¹å˜å®ƒçš„è¡Œä¸ºï¼Œå¯¹è±¡çœ‹èµ·æ¥ä¼¼ä¹ä¿®æ”¹äº†å®ƒçš„ç±»ã€‚
æˆ‘ä»¬ä»¥é€—å·åˆ†å‰²ï¼ŒæŠŠè¿™å¥è¯åˆ†ä¸ºä¸¤éƒ¨åˆ†æ¥çœ‹ã€‚ç¬¬ä¸€éƒ¨åˆ†çš„æ„æ€æ˜¯å°†çŠ¶æ€å°è£…æˆç‹¬ç«‹çš„ç±»ï¼Œå¹¶å°†è¯·æ±‚å§”æ‰˜ç»™å½“å‰çš„çŠ¶æ€å¯¹è±¡ï¼Œå½“å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€æ”¹å˜æ—¶ï¼Œä¼šå¸¦æ¥ä¸åŒçš„è¡Œä¸ºå˜åŒ–ã€‚ç”µç¯çš„ä¾‹å­è¶³ä»¥è¯´æ˜è¿™ä¸€ç‚¹ï¼Œåœ¨ off å’Œ on è¿™ä¸¤ç§ä¸åŒçš„çŠ¶æ€ä¸‹ï¼Œæˆ‘ä»¬ç‚¹å‡»åŒä¸€ä¸ªæŒ‰é’®ï¼Œå¾—åˆ°çš„è¡Œä¸ºåé¦ˆæ˜¯æˆªç„¶ä¸åŒçš„ã€‚

ç¬¬äºŒéƒ¨åˆ†æ˜¯ä»å®¢æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„å¯¹è±¡ï¼Œåœ¨ä¸åŒçš„çŠ¶æ€ä¸‹å…·æœ‰æˆªç„¶ä¸åŒçš„è¡Œä¸ºï¼Œè¿™ä¸ªå¯¹è±¡çœ‹èµ·æ¥æ˜¯ä»ä¸åŒçš„ç±»ä¸­å®ä¾‹åŒ–è€Œæ¥çš„ï¼Œå®é™…ä¸Šè¿™æ˜¯ä½¿ç”¨äº†å§”æ‰˜çš„æ•ˆæœã€‚

### 16.3 çŠ¶æ€æ¨¡å¼çš„é€šç”¨ç»“æ„

åœ¨å‰é¢çš„ç”µç¯ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®Œæˆäº†ä¸€ä¸ªçŠ¶æ€æ¨¡å¼ç¨‹åºçš„ç¼–å†™ã€‚é¦–å…ˆå®šä¹‰äº† Light ç±»ï¼ŒLight ç±»åœ¨è¿™é‡Œä¹Ÿè¢«ç§°ä¸ºä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ã€‚éšååœ¨ Light çš„æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è¦åˆ›å»ºæ¯ä¸€ä¸ªçŠ¶æ€ç±»çš„å®ä¾‹å¯¹è±¡ï¼ŒContext å°†æŒæœ‰è¿™äº›çŠ¶æ€å¯¹è±¡çš„å¼•ç”¨ï¼Œä»¥ä¾¿æŠŠè¯·æ±‚å§”æ‰˜ç»™çŠ¶æ€å¯¹è±¡ã€‚ç”¨æˆ·çš„è¯·æ±‚ï¼Œå³ç‚¹å‡» button çš„åŠ¨ä½œä¹Ÿæ˜¯å®ç°åœ¨ Context ä¸­çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
var Light = function () {
  this.offLightState = new OffLightState(this); // æŒæœ‰çŠ¶æ€å¯¹è±¡çš„å¼•ç”¨
  this.weakLightState = new WeakLightState(this);
  this.strongLightState = new StrongLightState(this);
  this.superStrongLightState = new SuperStrongLightState(this);
  this.button = null;
};
Light.prototype.init = function () {
  var button = document.createElement("button"),
    self = this;
  this.button = document.body.appendChild(button);
  this.button.innerHTML = "å¼€å…³";
  this.currState = this.offLightState; // è®¾ç½®é»˜è®¤åˆå§‹çŠ¶æ€
  this.button.onclick = function () {
    // å®šä¹‰ç”¨æˆ·çš„è¯·æ±‚åŠ¨ä½œ
    self.currState.buttonWasPressed();
  };
};
```

æ¥ä¸‹æ¥å¯èƒ½æ˜¯ä¸ªè‹¦åŠ›æ´»ï¼Œæˆ‘ä»¬è¦ç¼–å†™å„ç§çŠ¶æ€ç±»ï¼Œlight å¯¹è±¡è¢«ä¼ å…¥çŠ¶æ€ç±»çš„æ„é€ å‡½æ•°ï¼ŒçŠ¶æ€å¯¹è±¡ä¹Ÿéœ€è¦æŒæœ‰ light å¯¹è±¡çš„å¼•ç”¨ï¼Œä»¥ä¾¿è°ƒç”¨ light ä¸­çš„æ–¹æ³•æˆ–è€…ç›´æ¥æ“ä½œ light å¯¹è±¡ï¼š

```js
var OffLightState = function (light) {
  this.light = light;
};
OffLightState.prototype.buttonWasPressed = function () {
  console.log("å¼±å…‰");
  this.light.setState(this.light.weakLightState);
};
```

### 16.4 ç¼ºå°‘æŠ½è±¡ç±»çš„å˜é€šæ–¹å¼

æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨çŠ¶æ€ç±»ä¸­å°†å®šä¹‰ä¸€äº›å…±åŒçš„è¡Œä¸ºæ–¹æ³•ï¼ŒContext æœ€ç»ˆä¼šå°†è¯·æ±‚å§”æ‰˜ç»™çŠ¶æ€å¯¹è±¡çš„è¿™äº›æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯ buttonWasPressedã€‚æ— è®ºå¢åŠ äº†å¤šå°‘ç§çŠ¶æ€ç±»ï¼Œå®ƒä»¬éƒ½å¿…é¡»å®ç° buttonWasPressed æ–¹æ³•ã€‚

åœ¨ Java ä¸­ï¼Œæ‰€æœ‰çš„çŠ¶æ€ç±»å¿…é¡»ç»§æ‰¿è‡ªä¸€ä¸ª State æŠ½è±¡çˆ¶ç±»ï¼Œå½“ç„¶å¦‚æœæ²¡æœ‰å…±åŒçš„åŠŸèƒ½å€¼å¾—æ”¾å…¥æŠ½è±¡çˆ¶ç±»ä¸­ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©å®ç° State æ¥å£ã€‚è¿™æ ·åšçš„åŸå› ä¸€æ–¹é¢æ˜¯æˆ‘ä»¬æ›¾å¤šæ¬¡æè¿‡çš„å‘ä¸Šè½¬å‹ï¼Œå¦ä¸€æ–¹é¢æ˜¯ä¿è¯æ‰€æœ‰çš„çŠ¶æ€å­ç±»éƒ½å®ç°äº† buttonWasPressed æ–¹æ³•ã€‚é—æ†¾çš„æ˜¯ï¼ŒJavaScript æ—¢ä¸æ”¯æŒæŠ½è±¡ç±»ï¼Œä¹Ÿæ²¡æœ‰æ¥å£çš„æ¦‚å¿µã€‚æ‰€ä»¥åœ¨ä½¿ç”¨çŠ¶æ€æ¨¡å¼çš„æ—¶å€™è¦æ ¼å¤–å°å¿ƒï¼Œå¦‚æœæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªçŠ¶æ€å­ç±»æ—¶ï¼Œå¿˜è®°äº†ç»™è¿™ä¸ªçŠ¶æ€å­ç±»å®ç° buttonWasPressed æ–¹æ³•ï¼Œåˆ™ä¼šåœ¨çŠ¶æ€åˆ‡æ¢çš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸ã€‚å› ä¸º Context æ€»æ˜¯æŠŠè¯·æ±‚å§”æ‰˜ç»™çŠ¶æ€å¯¹è±¡çš„ buttonWasPressed æ–¹æ³•ã€‚

ä¸è®ºæ€æ ·ä¸¥æ ¼è¦æ±‚ç¨‹åºå‘˜ï¼Œä¹Ÿè®¸éƒ½é¿å…ä¸äº†çŠ¯é”™çš„é‚£ä¸€å¤©ï¼Œæ¯•ç«Ÿå¦‚æœæ²¡æœ‰ç¼–è¯‘å™¨çš„å¸®åŠ©ï¼Œåªä¾é ç¨‹åºå‘˜çš„è‡ªè§‰ä»¥åŠä¸€ç‚¹å¥½è¿æ°”ï¼Œæ˜¯ä¸é è°±çš„ã€‚è¿™é‡Œå»ºè®®çš„è§£å†³æ–¹æ¡ˆè·Ÿã€Šæ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€‹ä¸­ä¸€è‡´ï¼Œè®©æŠ½è±¡çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ç›´æ¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œè¿™ä¸ªå¼‚å¸¸è‡³å°‘ä¼šåœ¨ç¨‹åºè¿è¡ŒæœŸé—´å°±è¢«å‘ç°ï¼š

```js
var State = function () {};
State.prototype.buttonWasPressed = function () {
  throw new Error("çˆ¶ç±»çš„buttonWasPressedæ–¹æ³•å¿…é¡»è¢«é‡å†™");
};
var SuperStrongLightState = function (light) {
  this.light = light;
};

SuperStrongLightState.prototype = new State(); // ç»§æ‰¿æŠ½è±¡çˆ¶ç±»
SuperStrongLightState.prototype.buttonWasPressed = function () {
  // é‡å†™buttonWasPressedæ–¹æ³•
  console.log("å…³ç¯");
  this.light.setState(this.light.offLightState);
};
```

### 16.5 å¦ä¸€ä¸ªçŠ¶æ€æ¨¡å¼ç¤ºä¾‹â€”â€”æ–‡ä»¶ä¸Šä¼ 

æ¥ä¸‹æ¥æˆ‘ä»¬è¦è®¨è®ºä¸€ä¸ªå¤æ‚ä¸€ç‚¹çš„ä¾‹å­ï¼Œè¿™åŸæœ¬æ˜¯ä¸€ä¸ªçœŸå®çš„é¡¹ç›®ï¼Œ æ˜¯æˆ‘ 2013 å¹´é‡æ„å¾®äº‘ä¸Šä¼ æ¨¡å—çš„ç»å†ã€‚å®é™…ä¸Šï¼Œä¸è®ºæ˜¯æ–‡ä»¶ä¸Šä¼ ï¼Œè¿˜æ˜¯éŸ³ä¹ã€è§†é¢‘æ’­æ”¾å™¨ï¼Œéƒ½å¯ä»¥æ‰¾åˆ°ä¸€äº›æ˜æ˜¾çš„çŠ¶æ€åŒºåˆ†ã€‚æ¯”å¦‚æ–‡ä»¶ä¸Šä¼ ç¨‹åºä¸­æœ‰æ‰«æã€æ­£åœ¨ä¸Šä¼ ã€æš‚åœã€ä¸Šä¼ æˆåŠŸã€ä¸Šä¼ å¤±è´¥è¿™å‡ ç§çŠ¶æ€ï¼ŒéŸ³ä¹æ’­æ”¾å™¨å¯ä»¥åˆ†ä¸ºåŠ è½½ä¸­ã€æ­£åœ¨æ’­æ”¾ã€æš‚åœã€æ’­æ”¾å®Œæ¯•è¿™å‡ ç§çŠ¶æ€ã€‚ç‚¹å‡»åŒä¸€ä¸ªæŒ‰é’®ï¼Œåœ¨ä¸Šä¼ ä¸­å’Œæš‚åœçŠ¶æ€ä¸‹çš„è¡Œä¸ºè¡¨ç°æ˜¯ä¸ä¸€æ ·çš„ï¼ŒåŒæ—¶å®ƒä»¬çš„æ ·å¼ class ä¹Ÿä¸åŒã€‚ä¸‹é¢æˆ‘ä»¬ä»¥æ–‡ä»¶ä¸Šä¼ ä¸ºä¾‹è¿›è¡Œè¯´æ˜ã€‚ä¸Šä¼ ä¸­ï¼Œç‚¹å‡»æŒ‰é’®æš‚åœï¼Œå¦‚å›¾ 16-3 æ‰€ç¤ºã€‚

å›¾ 16-3
æš‚åœä¸­ï¼Œç‚¹å‡»æŒ‰é’®ç»§ç»­æ’­æ”¾ï¼Œå¦‚å›¾ 16-4 æ‰€ç¤ºã€‚

å›¾ 16-4
çœ‹åˆ°è¿™é‡Œï¼Œå†è”ç³»ä¸€ä¸‹ç”µç¯çš„ä¾‹å­å’Œä¹‹å‰å¯¹çŠ¶æ€æ¨¡å¼çš„äº†è§£ï¼Œæˆ‘ä»¬å·²ç»æ‰¾äº†ä½¿ç”¨çŠ¶æ€æ¨¡å¼çš„ç†ç”±ã€‚

#### 16.5.1 æ›´å¤æ‚çš„åˆ‡æ¢æ¡ä»¶

ç›¸å¯¹äºç”µç¯çš„ä¾‹å­ï¼Œæ–‡ä»¶ä¸Šä¼ ä¸åŒçš„åœ°æ–¹åœ¨äºï¼Œç°åœ¨æˆ‘ä»¬å°†é¢ä¸´æ›´åŠ å¤æ‚çš„æ¡ä»¶åˆ‡æ¢å…³ç³»ã€‚
åœ¨ç”µç¯çš„ä¾‹å­ä¸­ï¼Œç”µç¯çš„çŠ¶æ€æ€»æ˜¯ä»å…³åˆ°å¼€å†åˆ°å…³ï¼Œæˆ–è€…ä»å…³åˆ°å¼±å…‰ã€å¼±å…‰åˆ°å¼ºå…‰ã€å¼ºå…‰å†åˆ°å…³ã€‚
çœ‹èµ·æ¥æ€»æ˜¯å¾ªè§„è¹ˆçŸ©çš„ Aâ†’Bâ†’Câ†’Aï¼Œæ‰€ä»¥å³ä½¿ä¸ä½¿ç”¨çŠ¶æ€æ¨¡å¼æ¥ç¼–å†™ç”µç¯çš„ç¨‹åºï¼Œè€Œæ˜¯ä½¿ç”¨åŸå§‹çš„ ifã€else æ¥æ§åˆ¶çŠ¶æ€åˆ‡æ¢ï¼Œæˆ‘ä»¬ä¹Ÿä¸è‡³äºåœ¨é€»è¾‘ç¼–å†™ä¸­è¿·å¤±è‡ªå·±ï¼Œå› ä¸ºçŠ¶æ€çš„åˆ‡æ¢æ€»æ˜¯éµå¾ªä¸€äº›ç®€å•çš„è§„å¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
if (this.state === "off") {
  console.log("å¼€å¼±å…‰");
  this.button.innerHTML = "ä¸‹ä¸€æ¬¡æŒ‰æˆ‘æ˜¯å¼ºå…‰";
  this.state = "weakLight";
} else if (this.state === "weakLight") {
  console.log("å¼€å¼ºå…‰");
  this.button.innerHTML = "ä¸‹ä¸€æ¬¡æŒ‰æˆ‘æ˜¯å…³ç¯";
  this.state = "strongLight";
} else if (this.state === "strongLight") {
  console.log("å…³ç¯");
  this.button.innerHTML = "ä¸‹ä¸€æ¬¡æŒ‰æˆ‘æ˜¯å¼±å…‰";
  this.state = "off";
}
```

è€Œæ–‡ä»¶ä¸Šä¼ çš„çŠ¶æ€åˆ‡æ¢ç›¸æ¯”è¦å¤æ‚å¾—å¤šï¼Œæ§åˆ¶æ–‡ä»¶ä¸Šä¼ çš„æµç¨‹éœ€è¦ä¸¤ä¸ªèŠ‚ç‚¹æŒ‰é’®ï¼Œç¬¬ä¸€ä¸ªç”¨äºæš‚åœå’Œç»§ç»­ä¸Šä¼ ï¼Œç¬¬äºŒä¸ªç”¨äºåˆ é™¤æ–‡ä»¶ï¼Œå¦‚å›¾ 16-5 æ‰€ç¤ºã€‚
å›¾ 16-5

ç°åœ¨çœ‹çœ‹æ–‡ä»¶åœ¨ä¸åŒçš„çŠ¶æ€ä¸‹ï¼Œç‚¹å‡»è¿™ä¸¤ä¸ªæŒ‰é’®å°†åˆ†åˆ«å‘ç”Ÿä»€ä¹ˆè¡Œä¸ºã€‚

- ğŸ”º æ–‡ä»¶åœ¨æ‰«æçŠ¶æ€ä¸­ï¼Œæ˜¯ä¸èƒ½è¿›è¡Œä»»ä½•æ“ä½œçš„ï¼Œæ—¢ä¸èƒ½æš‚åœä¹Ÿä¸èƒ½åˆ é™¤æ–‡ä»¶ï¼Œåªèƒ½ç­‰å¾…æ‰«æå®Œæˆã€‚æ‰«æå®Œæˆä¹‹åï¼Œæ ¹æ®æ–‡ä»¶çš„ md5 å€¼åˆ¤æ–­ï¼Œè‹¥ç¡®è®¤è¯¥æ–‡ä»¶å·²ç»å­˜åœ¨äºæœåŠ¡å™¨ï¼Œåˆ™ç›´æ¥è·³åˆ°ä¸Šä¼ å®ŒæˆçŠ¶æ€ã€‚å¦‚æœè¯¥æ–‡ä»¶çš„å¤§å°è¶…è¿‡å…è®¸ä¸Šä¼ çš„æœ€å¤§å€¼ï¼Œæˆ–è€…è¯¥æ–‡ä»¶å·²ç»æŸåï¼Œåˆ™è·³å¾€ä¸Šä¼ å¤±è´¥çŠ¶æ€ã€‚å‰©ä¸‹çš„æƒ…å†µä¸‹æ‰è¿›å…¥ä¸Šä¼ ä¸­çŠ¶æ€ã€‚
- ğŸ”º ä¸Šä¼ è¿‡ç¨‹ä¸­å¯ä»¥ç‚¹å‡»æš‚åœæŒ‰é’®æ¥æš‚åœä¸Šä¼ ï¼Œæš‚åœåç‚¹å‡»åŒä¸€ä¸ªæŒ‰é’®ä¼šç»§ç»­ä¸Šä¼ ã€‚
- ğŸ”º æ‰«æå’Œä¸Šä¼ è¿‡ç¨‹ä¸­ï¼Œç‚¹å‡»åˆ é™¤æŒ‰é’®æ— æ•ˆï¼Œåªæœ‰åœ¨æš‚åœã€ä¸Šä¼ å®Œæˆã€ä¸Šä¼ å¤±è´¥ä¹‹åï¼Œæ‰èƒ½åˆ é™¤æ–‡ä»¶ã€‚

#### 16.5.2 ä¸€äº›å‡†å¤‡å·¥ä½œ

å¾®äº‘æä¾›äº†ä¸€äº›æµè§ˆå™¨æ’ä»¶æ¥å¸®åŠ©å®Œæˆæ–‡ä»¶ä¸Šä¼ ã€‚æ’ä»¶ç±»å‹æ ¹æ®æµè§ˆå™¨çš„ä¸åŒï¼Œæœ‰å¯èƒ½æ˜¯ ActiveObjectï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ WebkitPluginã€‚

ä¸Šä¼ æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥æ§ä»¶ä¼šä¸åœåœ°è°ƒç”¨ JavaScript æä¾›çš„ä¸€ä¸ªå…¨å±€å‡½æ•° window.external.uploadï¼Œæ¥é€šçŸ¥ JavaScript ç›®å‰çš„ä¸Šä¼ è¿›åº¦ï¼Œæ§ä»¶ä¼šæŠŠå½“å‰çš„æ–‡ä»¶çŠ¶æ€ä½œä¸ºå‚ state å¡è¿› window.external.uploadã€‚åœ¨è¿™é‡Œæ— æ³•æä¾›ä¸€ä¸ªå®Œæ•´çš„ä¸Šä¼ æ’ä»¶ï¼Œæˆ‘ä»¬å°†ç®€å•åœ° setTimeout æ¥æ¨¡æ‹Ÿæ–‡ä»¶çš„ä¸Šä¼ è¿›åº¦ï¼Œwindow.external.upload å‡½æ•°åœ¨æ­¤ä¾‹ä¸­ä¹Ÿåªè´Ÿè´£æ‰“å°ä¸€äº› logï¼š

```js
window.external.upload = function (state) {
  console.log(state); // å¯èƒ½ä¸ºsignã€uploadingã€doneã€error
};
```

å¦å¤–æˆ‘ä»¬éœ€è¦åœ¨é¡µé¢ä¸­æ”¾ç½®ä¸€ä¸ªç”¨äºä¸Šä¼ çš„æ’ä»¶å¯¹è±¡ï¼š

```js
var plugin = (function () {
  var plugin = document.createElement("embed");
  plugin.style.display = "none";
  plugin.type = "application/txftn-webkit";
  plugin.sign = function () {
    console.log("å¼€å§‹æ–‡ä»¶æ‰«æ");
  };
  plugin.pause = function () {
    console.log("æš‚åœæ–‡ä»¶ä¸Šä¼ ");
  };
  plugin.uploading = function () {
    console.log("å¼€å§‹æ–‡ä»¶ä¸Šä¼ ");
  };
  plugin.del = function () {
    console.log("åˆ é™¤æ–‡ä»¶ä¸Šä¼ ");
  };
  plugin.done = function () {
    console.log("æ–‡ä»¶ä¸Šä¼ å®Œæˆ");
  };
  document.body.appendChild(plugin);
  return plugin;
})();
```

#### 16.5.3 å¼€å§‹ç¼–å†™ä»£ç 

æ¥ä¸‹æ¥å¼€å§‹å®Œæˆå…¶ä»–ä»£ç çš„ç¼–å†™ï¼Œå…ˆå®šä¹‰ Upload ç±»ï¼Œæ§åˆ¶ä¸Šä¼ è¿‡ç¨‹çš„å¯¹è±¡å°†ä» Upload ç±»ä¸­åˆ›å»ºè€Œæ¥ï¼š

```js
var Upload = function (fileName) {
  this.plugin = plugin;
  this.fileName = fileName;
  this.button1 = null;
  this.button2 = null;
  this.state = "sign"; // è®¾ç½®åˆå§‹çŠ¶æ€ä¸ºwaiting
};
```

Upload.prototype.init æ–¹æ³•ä¼šè¿›è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼ŒåŒ…æ‹¬åˆ›å»ºé¡µé¢ä¸­çš„ä¸€äº›èŠ‚ç‚¹ã€‚åœ¨è¿™äº›èŠ‚ç‚¹é‡Œï¼Œèµ·ä¸»è¦ä½œç”¨çš„æ˜¯ä¸¤ä¸ªç”¨äºæ§åˆ¶ä¸Šä¼ æµç¨‹çš„æŒ‰é’®ï¼Œç¬¬ä¸€ä¸ªæŒ‰é’®ç”¨äºæš‚åœå’Œç»§ç»­ä¸Šä¼ ï¼Œç¬¬äºŒä¸ªç”¨äºåˆ é™¤æ–‡ä»¶ï¼š

```js
Upload.prototype.init = function () {
  var that = this;
  this.dom = document.createElement("div");
  this.dom.innerHTML =
    "<span>æ–‡ä»¶åç§°:" +
    this.fileName +
    '</span>\
<button data-action="button1">æ‰«æä¸­</button>\
<button data-action="button2">åˆ é™¤</button>';
  document.body.appendChild(this.dom);
  this.button1 = this.dom.querySelector('[data-action="button1"]'); // ç¬¬ä¸€ä¸ªæŒ‰é’®
  this.button2 = this.dom.querySelector('[data-action="button2"]'); // ç¬¬äºŒä¸ªæŒ‰é’®
  this.bindEvent();
};
```

æ¥ä¸‹æ¥éœ€è¦ç»™ä¸¤ä¸ªæŒ‰é’®åˆ†åˆ«ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼š

```js
Upload.prototype.bindEvent = function () {
  var self = this;
  this.button1.onclick = function () {
    if (self.state === "sign") {
      // æ‰«æçŠ¶æ€ä¸‹ï¼Œä»»ä½•æ“ä½œæ— æ•ˆ
      console.log("æ‰«æä¸­ï¼Œç‚¹å‡»æ— æ•ˆ...");
    } else if (self.state === "uploading") {
      // ä¸Šä¼ ä¸­ï¼Œç‚¹å‡»åˆ‡æ¢åˆ°æš‚åœ
      self.changeState("pause");
    } else if (self.state === "pause") {
      // æš‚åœä¸­ï¼Œç‚¹å‡»åˆ‡æ¢åˆ°ä¸Šä¼ ä¸­
      self.changeState("uploading");
    } else if (self.state === "done") {
      console.log("æ–‡ä»¶å·²å®Œæˆä¸Šä¼ , ç‚¹å‡»æ— æ•ˆ");
    } else if (self.state === "error") {
      console.log("æ–‡ä»¶ä¸Šä¼ å¤±è´¥, ç‚¹å‡»æ— æ•ˆ");
    }
  };
  this.button2.onclick = function () {
    if (
      self.state === "done" ||
      self.state === "error" ||
      self.state === "pause"
    ) {
      // ä¸Šä¼ å®Œæˆã€ä¸Šä¼ å¤±è´¥å’Œæš‚åœçŠ¶æ€ä¸‹å¯ä»¥åˆ é™¤
      self.changeState("del");
    } else if (self.state === "sign") {
      console.log("æ–‡ä»¶æ­£åœ¨æ‰«æä¸­ï¼Œä¸èƒ½åˆ é™¤");
    } else if (self.state === "uploading") {
      console.log("æ–‡ä»¶æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œä¸èƒ½åˆ é™¤");
    }
  };
};
```

å†æ¥ä¸‹æ¥æ˜¯ Upload.prototype.changeState æ–¹æ³•ï¼Œå®ƒè´Ÿè´£åˆ‡æ¢çŠ¶æ€ä¹‹åçš„å…·ä½“è¡Œä¸ºï¼ŒåŒ…æ‹¬æ”¹å˜æŒ‰é’®çš„ innerHTMLï¼Œä»¥åŠè°ƒç”¨æ’ä»¶å¼€å§‹ä¸€äº›â€œçœŸæ­£â€çš„æ“ä½œï¼š

```js
Upload.prototype.changeState = function (state) {
  switch (state) {
    case "sign":
      this.plugin.sign();
      this.button1.innerHTML = "æ‰«æä¸­ï¼Œä»»ä½•æ“ä½œæ— æ•ˆ";
      break;
    case "uploading":
      this.plugin.uploading();
      this.button1.innerHTML = "æ­£åœ¨ä¸Šä¼ ï¼Œç‚¹å‡»æš‚åœ";
      break;
    case "pause":
      this.plugin.pause();
      this.button1.innerHTML = "å·²æš‚åœï¼Œç‚¹å‡»ç»§ç»­ä¸Šä¼ ";
      break;
    case "done":
      this.plugin.done();
      this.button1.innerHTML = "ä¸Šä¼ å®Œæˆ";
      break;
    case "error":
      this.button1.innerHTML = "ä¸Šä¼ å¤±è´¥";
      break;
    case "del":
      this.plugin.del();
      this.dom.parentNode.removeChild(this.dom);
      console.log("åˆ é™¤å®Œæˆ");
      break;
  }
  this.state = state;
};
```

æœ€åæˆ‘ä»¬æ¥è¿›è¡Œä¸€äº›æµ‹è¯•å·¥ä½œï¼š

```js
var uploadObj = new Upload("JavaScriptè®¾è®¡æ¨¡å¼ä¸å¼€å‘å®è·µ");
uploadObj.init();
window.external.upload = function (state) {
  // æ’ä»¶è°ƒç”¨JavaScriptçš„æ–¹æ³•
  uploadObj.changeState(state);
};
window.external.upload("sign"); // æ–‡ä»¶å¼€å§‹æ‰«æ
setTimeout(function () {
  window.external.upload("uploading"); // 1ç§’åå¼€å§‹ä¸Šä¼ 
}, 1000);
setTimeout(function () {
  window.external.upload("done"); // 5ç§’åä¸Šä¼ å®Œæˆ
}, 5000);
```

è‡³æ­¤å°±å®Œæˆäº†ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ä¸Šä¼ ç¨‹åºçš„ç¼–å†™ã€‚å½“ç„¶è¿™ä»ç„¶æ˜¯ä¸€ä¸ªåä¾‹ï¼Œè¿™é‡Œçš„ç¼ºç‚¹è·Ÿç”µç¯ä¾‹å­ä¸­çš„ç¬¬ä¸€æ®µä»£ç ä¸€æ ·ï¼Œç¨‹åºä¸­å……æ–¥ç€ ifã€else æ¡ä»¶åˆ†æ”¯ï¼ŒçŠ¶æ€å’Œè¡Œä¸ºéƒ½è¢«è€¦åˆåœ¨ä¸€ä¸ªå·¨å¤§çš„æ–¹æ³•é‡Œï¼Œ æˆ‘ä»¬å¾ˆéš¾ä¿®æ”¹å’Œæ‰©å±•è¿™ä¸ªçŠ¶æ€æœºã€‚æ–‡ä»¶çŠ¶æ€ä¹‹é—´çš„è”ç³»å¦‚æ­¤å¤æ‚ï¼Œè¿™ä¸ªé—®é¢˜æ˜¾å¾—æ›´åŠ ä¸¥é‡äº†ã€‚

#### 16.5.4 çŠ¶æ€æ¨¡å¼é‡æ„æ–‡ä»¶ä¸Šä¼ ç¨‹åº

çŠ¶æ€æ¨¡å¼åœ¨æ–‡ä»¶ä¸Šä¼ çš„ç¨‹åºä¸­ï¼Œæ˜¯æœ€ä¼˜é›…çš„è§£å†³åŠæ³•ä¹‹ä¸€ã€‚é€šè¿‡ç”µç¯çš„ä¾‹å­ï¼Œæˆ‘ä»¬å·²ç»ç†ŸçŸ¥çŠ¶æ€æ¨¡å¼çš„ç»“æ„äº†ï¼Œä¸‹é¢å°±å¼€å§‹ä¸€æ­¥æ­¥åœ°é‡æ„å®ƒã€‚

ç¬¬ä¸€æ­¥ä»ç„¶æ˜¯æä¾› window.external.upload å‡½æ•°ï¼Œåœ¨é¡µé¢ä¸­æ¨¡æ‹Ÿåˆ›å»ºä¸Šä¼ æ’ä»¶ï¼Œè¿™éƒ¨åˆ†ä»£ç æ²¡æœ‰æ”¹å˜ï¼š

```js
window.external.upload = function (state) {
  console.log(state); // å¯èƒ½ä¸ºsignã€uploadingã€doneã€error
};
var plugin = (function () {
  var plugin = document.createElement("embed");
  plugin.style.display = "none";
  plugin.type = "application/txftn-webkit";
  plugin.sign = function () {
    console.log("å¼€å§‹æ–‡ä»¶æ‰«æ");
  };
  plugin.pause = function () {
    console.log("æš‚åœæ–‡ä»¶ä¸Šä¼ ");
  };
  plugin.uploading = function () {
    console.log("å¼€å§‹æ–‡ä»¶ä¸Šä¼ ");
  };
  plugin.del = function () {
    console.log("åˆ é™¤æ–‡ä»¶ä¸Šä¼ ");
  };
  plugin.done = function () {
    console.log("æ–‡ä»¶ä¸Šä¼ å®Œæˆ");
  };
  document.body.appendChild(plugin);
  return plugin;
})();
```

ç¬¬äºŒæ­¥ï¼Œæ”¹é€  Upload æ„é€ å‡½æ•°ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ä¸ºæ¯ç§çŠ¶æ€å­ç±»éƒ½åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼š

```js
var Upload = function (fileName) {
  this.plugin = plugin;
  this.fileName = fileName;
  this.button1 = null;
  this.button2 = null;
  this.signState = new SignState(this); // è®¾ç½®åˆå§‹çŠ¶æ€ä¸ºwaiting
  this.uploadingState = new UploadingState(this);
  this.pauseState = new PauseState(this);
  this.doneState = new DoneState(this);
  this.errorState = new ErrorState(this);
  this.currState = this.signState; // è®¾ç½®å½“å‰çŠ¶æ€
};
```

ç¬¬ä¸‰æ­¥ï¼ŒUpload.prototype.init æ–¹æ³•æ— éœ€æ”¹å˜ï¼Œä»ç„¶è´Ÿè´£å¾€é¡µé¢ä¸­åˆ›å»ºè·Ÿä¸Šä¼ æµç¨‹æœ‰å…³çš„ DOM èŠ‚ç‚¹ï¼Œå¹¶å¼€å§‹ç»‘å®šæŒ‰é’®çš„äº‹ä»¶ï¼š

```js
Upload.prototype.init = function () {
  var that = this;
  this.dom = document.createElement("div");
  this.dom.innerHTML =
    "<span>æ–‡ä»¶åç§°:" +
    this.fileName +
    '</span>\
<button data-action="button1">æ‰«æä¸­</button>\
<button data-action="button2">åˆ é™¤</button>';
  document.body.appendChild(this.dom);
  this.button1 = this.dom.querySelector('[data-action="button1"]');
  this.button2 = this.dom.querySelector('[data-action="button2"]');
  this.bindEvent();
};
```

ç¬¬å››æ­¥ï¼Œè´Ÿè´£å…·ä½“çš„æŒ‰é’®äº‹ä»¶å®ç°ï¼Œåœ¨ç‚¹å‡»äº†æŒ‰é’®ä¹‹åï¼ŒContext å¹¶ä¸åšä»»ä½•å…·ä½“çš„æ“ä½œï¼Œè€Œæ˜¯æŠŠè¯·æ±‚å§”æ‰˜ç»™å½“å‰çš„çŠ¶æ€ç±»æ¥æ‰§è¡Œï¼š

```js
Upload.prototype.bindEvent = function () {
  var self = this;
  this.button1.onclick = function () {
    self.currState.clickHandler1();
  };
  this.button2.onclick = function () {
    self.currState.clickHandler2();
  };
};
```

ç¬¬å››æ­¥ä¸­çš„ä»£ç æœ‰ä¸€äº›å˜åŒ–ï¼Œæˆ‘ä»¬æŠŠçŠ¶æ€å¯¹åº”çš„é€»è¾‘è¡Œä¸ºæ”¾åœ¨ Upload ç±»ä¸­ï¼š

```js
Upload.prototype.sign = function () {
  this.plugin.sign();
  this.currState = this.signState;
};
Upload.prototype.uploading = function () {
  this.button1.innerHTML = "æ­£åœ¨ä¸Šä¼ ï¼Œç‚¹å‡»æš‚åœ";
  this.plugin.uploading();
  this.currState = this.uploadingState;
};
Upload.prototype.pause = function () {
  this.button1.innerHTML = "å·²æš‚åœï¼Œç‚¹å‡»ç»§ç»­ä¸Šä¼ ";
  this.plugin.pause();
  this.currState = this.pauseState;
};
Upload.prototype.done = function () {
  this.button1.innerHTML = "ä¸Šä¼ å®Œæˆ";
  this.plugin.done();
  this.currState = this.doneState;
};
Upload.prototype.error = function () {
  this.button1.innerHTML = "ä¸Šä¼ å¤±è´¥";
  this.currState = this.errorState;
};
Upload.prototype.del = function () {
  this.plugin.del();
  this.dom.parentNode.removeChild(this.dom);
};
```

ç¬¬äº”æ­¥ï¼Œå·¥ä½œç•¥æ˜¾ä¹å‘³ï¼Œæˆ‘ä»¬è¦ç¼–å†™å„ä¸ªçŠ¶æ€ç±»çš„å®ç°ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†
StateFactoryï¼Œä»è€Œé¿å…å› ä¸º JavaScript ä¸­æ²¡æœ‰æŠ½è±¡ç±»æ‰€å¸¦æ¥çš„é—®é¢˜ã€‚

```js
var StateFactory = (function () {
  var State = function () {};
  State.prototype.clickHandler1 = function () {
    throw new Error("å­ç±»å¿…é¡»é‡å†™çˆ¶ç±»çš„clickHandler1æ–¹æ³•");
  };
  State.prototype.clickHandler2 = function () {
    throw new Error("å­ç±»å¿…é¡»é‡å†™çˆ¶ç±»çš„clickHandler2æ–¹æ³•");
  };
  return function (param) {
    var F = function (uploadObj) {
      this.uploadObj = uploadObj;
    };
    F.prototype = new State();
    for (var i in param) {
      F.prototype[i] = param[i];
    }
    return F;
  };
})();
var SignState = StateFactory({
  clickHandler1: function () {
    console.log("æ‰«æä¸­ï¼Œç‚¹å‡»æ— æ•ˆ...");
  },
  clickHandler2: function () {
    console.log("æ–‡ä»¶æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œä¸èƒ½åˆ é™¤");
  },
});
var UploadingState = StateFactory({
  clickHandler1: function () {
    this.uploadObj.pause();
  },
  clickHandler2: function () {
    console.log("æ–‡ä»¶æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œä¸èƒ½åˆ é™¤");
  },
});
var PauseState = StateFactory({
  clickHandler1: function () {
    this.uploadObj.uploading();
  },
  clickHandler2: function () {
    this.uploadObj.del();
  },
});
var DoneState = StateFactory({
  clickHandler1: function () {
    console.log("æ–‡ä»¶å·²å®Œæˆä¸Šä¼ , ç‚¹å‡»æ— æ•ˆ");
  },
  clickHandler2: function () {
    this.uploadObj.del();
  },
});
var ErrorState = StateFactory({
  clickHandler1: function () {
    console.log("æ–‡ä»¶ä¸Šä¼ å¤±è´¥, ç‚¹å‡»æ— æ•ˆ");
  },
  clickHandler2: function () {
    this.uploadObj.del();
  },
});
```

æœ€åæ˜¯æµ‹è¯•æ—¶é—´ï¼š

```js
var uploadObj = new Upload("JavaScriptè®¾è®¡æ¨¡å¼ä¸å¼€å‘å®è·µ");
uploadObj.init();
window.external.upload = function (state) {
  uploadObj[state]();
};
window.external.upload("sign");

setTimeout(function () {
  window.external.upload("uploading"); // 1ç§’åå¼€å§‹ä¸Šä¼ 
}, 1000);
setTimeout(function () {
  window.external.upload("done"); // 5ç§’åä¸Šä¼ å®Œæˆ
}, 5000);
```

### 16.6 çŠ¶æ€æ¨¡å¼çš„ä¼˜ç¼ºç‚¹

åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†ä¸¤ä¸ªçŠ¶æ€æ¨¡å¼çš„ä¾‹å­ï¼Œç°åœ¨æ˜¯æ—¶å€™æ¥æ€»ç»“çŠ¶æ€æ¨¡å¼çš„ä¼˜ç¼ºç‚¹äº†ã€‚çŠ¶æ€æ¨¡å¼çš„ä¼˜ç‚¹å¦‚ä¸‹ã€‚

- ğŸ”º çŠ¶æ€æ¨¡å¼å®šä¹‰äº†çŠ¶æ€ä¸è¡Œä¸ºä¹‹é—´çš„å…³ç³»ï¼Œå¹¶å°†å®ƒä»¬å°è£…åœ¨ä¸€ä¸ªç±»é‡Œã€‚é€šè¿‡å¢åŠ æ–°çš„çŠ¶æ€ç±»ï¼Œå¾ˆå®¹æ˜“å¢åŠ æ–°çš„çŠ¶æ€å’Œè½¬æ¢ã€‚
- ğŸ”º é¿å… Context æ— é™è†¨èƒ€ï¼ŒçŠ¶æ€åˆ‡æ¢çš„é€»è¾‘è¢«åˆ†å¸ƒåœ¨çŠ¶æ€ç±»ä¸­ï¼Œä¹Ÿå»æ‰äº† Context ä¸­åŸæœ¬è¿‡
  å¤šçš„æ¡ä»¶åˆ†æ”¯ã€‚
- ğŸ”º ç”¨å¯¹è±¡ä»£æ›¿å­—ç¬¦ä¸²æ¥è®°å½•å½“å‰çŠ¶æ€ï¼Œä½¿å¾—çŠ¶æ€çš„åˆ‡æ¢æ›´åŠ ä¸€ç›®äº†ç„¶ã€‚
- ğŸ”º Context ä¸­çš„è¯·æ±‚åŠ¨ä½œå’ŒçŠ¶æ€ç±»ä¸­å°è£…çš„è¡Œä¸ºå¯ä»¥éå¸¸å®¹æ˜“åœ°ç‹¬ç«‹å˜åŒ–è€Œäº’ä¸å½±å“ã€‚

çŠ¶æ€æ¨¡å¼çš„ç¼ºç‚¹æ˜¯ä¼šåœ¨ç³»ç»Ÿä¸­å®šä¹‰è®¸å¤šçŠ¶æ€ç±»ï¼Œç¼–å†™ 20 ä¸ªçŠ¶æ€ç±»æ˜¯ä¸€é¡¹æ¯ç‡¥ä¹å‘³çš„å·¥ä½œï¼Œ
è€Œä¸”ç³»ç»Ÿä¸­ä¼šå› æ­¤è€Œå¢åŠ ä¸å°‘å¯¹è±¡ã€‚å¦å¤–ï¼Œç”±äºé€»è¾‘åˆ†æ•£åœ¨çŠ¶æ€ç±»ä¸­ï¼Œè™½ç„¶é¿å¼€äº†ä¸å—æ¬¢è¿çš„æ¡
ä»¶åˆ†æ”¯è¯­å¥ï¼Œä½†ä¹Ÿé€ æˆäº†é€»è¾‘åˆ†æ•£çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ— æ³•åœ¨ä¸€ä¸ªåœ°æ–¹å°±çœ‹å‡ºæ•´ä¸ªçŠ¶æ€æœºçš„é€»è¾‘ã€‚

### 16.7 çŠ¶æ€æ¨¡å¼ä¸­çš„æ€§èƒ½ä¼˜åŒ–ç‚¹

åœ¨è¿™ä¸¤ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å¤ªå¤šåœ°ä»æ€§èƒ½æ–¹é¢è€ƒè™‘é—®é¢˜ï¼Œå®é™…ä¸Šï¼Œè¿™é‡Œæœ‰ä¸€äº›æ¯”è¾ƒå¤§çš„ä¼˜åŒ–ç‚¹ã€‚

- ğŸ”º æœ‰ä¸¤ç§é€‰æ‹©æ¥ç®¡ç† state å¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ã€‚ç¬¬ä¸€ç§æ˜¯ä»…å½“ state å¯¹è±¡è¢«éœ€è¦æ—¶æ‰åˆ›å»ºå¹¶éšåé”€æ¯ï¼Œå¦ä¸€ç§æ˜¯ä¸€å¼€å§‹å°±åˆ›å»ºå¥½æ‰€æœ‰çš„çŠ¶æ€å¯¹è±¡ï¼Œå¹¶ä¸”å§‹ç»ˆä¸é”€æ¯å®ƒä»¬ã€‚å¦‚æœ state å¯¹è±¡æ¯”è¾ƒåºå¤§ï¼Œå¯ä»¥ç”¨ç¬¬ä¸€ç§æ–¹å¼æ¥èŠ‚çœå†…å­˜ï¼Œè¿™æ ·å¯ä»¥é¿å…åˆ›å»ºä¸€äº›ä¸ä¼šç”¨åˆ°çš„å¯¹è±¡å¹¶åŠæ—¶åœ°å›æ”¶å®ƒä»¬ã€‚ä½†å¦‚æœçŠ¶æ€çš„æ”¹å˜å¾ˆé¢‘ç¹ï¼Œæœ€å¥½ä¸€å¼€å§‹å°±æŠŠè¿™äº› state å¯¹è±¡éƒ½åˆ›å»ºå‡ºæ¥ï¼Œä¹Ÿæ²¡æœ‰å¿…è¦é”€æ¯å®ƒä»¬ï¼Œå› ä¸ºå¯èƒ½å¾ˆå¿«å°†å†æ¬¡ç”¨åˆ°å®ƒä»¬ã€‚
- ğŸ”º åœ¨æœ¬ç« çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ª Context å¯¹è±¡éƒ½åˆ›å»ºäº†ä¸€ç»„ state å¯¹è±¡ï¼Œå®é™…ä¸Šè¿™äº› state å¯¹è±¡ä¹‹é—´æ˜¯å¯ä»¥å…±äº«çš„ï¼Œå„ Context å¯¹è±¡å¯ä»¥å…±äº«ä¸€ä¸ª state å¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯äº«å…ƒæ¨¡å¼çš„åº”ç”¨åœºæ™¯ä¹‹ä¸€ã€‚

### 16.8 çŠ¶æ€æ¨¡å¼å’Œç­–ç•¥æ¨¡å¼çš„å…³ç³»

çŠ¶æ€æ¨¡å¼å’Œç­–ç•¥æ¨¡å¼åƒä¸€å¯¹åŒèƒèƒï¼Œå®ƒä»¬éƒ½å°è£…äº†ä¸€ç³»åˆ—çš„ç®—æ³•æˆ–è€…è¡Œä¸ºï¼Œå®ƒä»¬çš„ç±»å›¾çœ‹èµ·æ¥å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œä½†åœ¨æ„å›¾ä¸Šæœ‰å¾ˆå¤§ä¸åŒï¼Œå› æ­¤å®ƒä»¬æ˜¯ä¸¤ç§è¿¥ç„¶ä¸åŒçš„æ¨¡å¼ã€‚

ç­–ç•¥æ¨¡å¼å’ŒçŠ¶æ€æ¨¡å¼çš„ç›¸åŒç‚¹æ˜¯ï¼Œå®ƒä»¬éƒ½æœ‰ä¸€ä¸ªä¸Šä¸‹æ–‡ã€ä¸€äº›ç­–ç•¥æˆ–è€…çŠ¶æ€ç±»ï¼Œä¸Šä¸‹æ–‡æŠŠè¯·æ±‚å§”æ‰˜ç»™è¿™äº›ç±»æ¥æ‰§è¡Œã€‚

å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ç­–ç•¥æ¨¡å¼ä¸­çš„å„ä¸ªç­–ç•¥ç±»ä¹‹é—´æ˜¯å¹³ç­‰åˆå¹³è¡Œçš„ï¼Œå®ƒä»¬ä¹‹é—´æ²¡æœ‰ä»»ä½•è”ç³»ï¼Œæ‰€ä»¥å®¢æˆ·å¿…é¡»ç†ŸçŸ¥è¿™äº›ç­–ç•¥ç±»çš„ä½œç”¨ï¼Œä»¥ä¾¿å®¢æˆ·å¯ä»¥éšæ—¶ä¸»åŠ¨åˆ‡æ¢ç®—æ³•ï¼›è€Œåœ¨çŠ¶æ€æ¨¡å¼ä¸­ï¼ŒçŠ¶æ€å’ŒçŠ¶æ€å¯¹åº”çš„è¡Œä¸ºæ˜¯æ—©å·²è¢«å°è£…å¥½çš„ï¼ŒçŠ¶æ€ä¹‹é—´çš„åˆ‡æ¢ä¹Ÿæ—©è¢«è§„å®šå®Œæˆï¼Œâ€œæ”¹å˜è¡Œä¸ºâ€è¿™ä»¶äº‹æƒ…å‘ç”Ÿåœ¨çŠ¶æ€æ¨¡å¼å†…éƒ¨ã€‚å¯¹å®¢æˆ·æ¥è¯´ï¼Œå¹¶ä¸éœ€è¦äº†è§£è¿™äº›ç»†èŠ‚ã€‚è¿™æ­£æ˜¯çŠ¶æ€æ¨¡å¼çš„ä½œç”¨æ‰€åœ¨ã€‚

### 16.9 JavaScript ç‰ˆæœ¬çš„çŠ¶æ€æœº

å‰é¢ä¸¤ä¸ªç¤ºä¾‹éƒ½æ˜¯æ¨¡æ‹Ÿä¼ ç»Ÿé¢å‘å¯¹è±¡è¯­è¨€çš„çŠ¶æ€æ¨¡å¼å®ç°ï¼Œæˆ‘ä»¬ä¸ºæ¯ç§çŠ¶æ€éƒ½å®šä¹‰ä¸€ä¸ªçŠ¶æ€å­ç±»ï¼Œç„¶ååœ¨ Context ä¸­æŒæœ‰è¿™äº›çŠ¶æ€å¯¹è±¡çš„å¼•ç”¨ï¼Œä»¥ä¾¿æŠŠ currState è®¾ç½®ä¸ºå½“å‰çš„çŠ¶æ€å¯¹è±¡ã€‚

çŠ¶æ€æ¨¡å¼æ˜¯çŠ¶æ€æœºçš„å®ç°ä¹‹ä¸€ï¼Œä½†åœ¨ JavaScript è¿™ç§â€œæ— ç±»â€è¯­è¨€ä¸­ï¼Œæ²¡æœ‰è§„å®šè®©çŠ¶æ€å¯¹è±¡ä¸€å®šè¦ä»ç±»ä¸­åˆ›å»ºè€Œæ¥ã€‚å¦å¤–ä¸€ç‚¹ï¼ŒJavaScript å¯ä»¥éå¸¸æ–¹ä¾¿åœ°ä½¿ç”¨å§”æ‰˜æŠ€æœ¯ï¼Œå¹¶ä¸éœ€è¦äº‹å…ˆè®©ä¸€ä¸ªå¯¹è±¡æŒæœ‰å¦ä¸€ä¸ªå¯¹è±¡ã€‚ä¸‹é¢çš„çŠ¶æ€æœºé€‰æ‹©äº†é€šè¿‡ Function.prototype.call æ–¹æ³•ç›´æ¥æŠŠè¯·æ±‚å§”æ‰˜ç»™æŸä¸ªå­—é¢é‡å¯¹è±¡æ¥æ‰§è¡Œã€‚

ä¸‹é¢æ”¹å†™ç”µç¯çš„ä¾‹å­ï¼Œæ¥å±•ç¤ºè¿™ç§æ›´åŠ è½»å·§çš„åšæ³•ï¼š

```js
var Light = function () {
  this.currState = FSM.off; // è®¾ç½®å½“å‰çŠ¶æ€
  this.button = null;
};
Light.prototype.init = function () {
  var button = document.createElement("button"),
    self = this;
  button.innerHTML = "å·²å…³ç¯";
  this.button = document.body.appendChild(button);
  this.button.onclick = function () {
    self.currState.buttonWasPressed.call(self); // æŠŠè¯·æ±‚å§”æ‰˜ç»™FSMçŠ¶æ€æœº
  };
};
var FSM = {
  off: {
    buttonWasPressed: function () {
      console.log("å…³ç¯");
      this.button.innerHTML = "ä¸‹ä¸€æ¬¡æŒ‰æˆ‘æ˜¯å¼€ç¯";
      this.currState = FSM.on;
    },
  },
  on: {
    buttonWasPressed: function () {
      console.log("å¼€ç¯");
      this.button.innerHTML = "ä¸‹ä¸€æ¬¡æŒ‰æˆ‘æ˜¯å…³ç¯";
      this.currState = FSM.off;
    },
  },
};
var light = new Light();
light.init();
```

æ¥ä¸‹æ¥å°è¯•å¦å¤–ä¸€ç§æ–¹æ³•ï¼Œå³åˆ©ç”¨ä¸‹é¢çš„ delegate å‡½æ•°æ¥å®Œæˆè¿™ä¸ªçŠ¶æ€æœºç¼–å†™ã€‚è¿™æ˜¯é¢å‘å¯¹è±¡è®¾è®¡å’Œé—­åŒ…äº’æ¢çš„ä¸€ä¸ªä¾‹å­ï¼Œå‰è€…æŠŠå˜é‡ä¿å­˜ä¸ºå¯¹è±¡çš„å±æ€§ï¼Œè€Œåè€…æŠŠå˜é‡å°é—­åœ¨é—­åŒ…å½¢æˆçš„ç¯å¢ƒä¸­ï¼š

```js
var delegate = function (client, delegation) {
  return {
    buttonWasPressed: function () {
      // å°†å®¢æˆ·çš„æ“ä½œå§”æ‰˜ç»™delegationå¯¹è±¡
      return delegation.buttonWasPressed.apply(client, arguments);
    },
  };
};
var FSM = {
  off: {
    buttonWasPressed: function () {
      console.log("å…³ç¯");
      this.button.innerHTML = "ä¸‹ä¸€æ¬¡æŒ‰æˆ‘æ˜¯å¼€ç¯";
      this.currState = this.onState;
    },
  },
  on: {
    buttonWasPressed: function () {
      console.log("å¼€ç¯");
      this.button.innerHTML = "ä¸‹ä¸€æ¬¡æŒ‰æˆ‘æ˜¯å…³ç¯";
      this.currState = this.offState;
    },
  },
};
var Light = function () {
  this.offState = delegate(this, FSM.off);
  this.onState = delegate(this, FSM.on);
  this.currState = this.offState; // è®¾ç½®åˆå§‹çŠ¶æ€ä¸ºå…³é—­çŠ¶æ€
  this.button = null;
};
Light.prototype.init = function () {
  var button = document.createElement("button"),
    self = this;
  button.innerHTML = "å·²å…³ç¯";
  this.button = document.body.appendChild(button);
  this.button.onclick = function () {
    self.currState.buttonWasPressed();
  };
};
var light = new Light();
light.init();
```

### 16.10 è¡¨é©±åŠ¨çš„æœ‰é™çŠ¶æ€æœº

å…¶å®è¿˜æœ‰å¦å¤–ä¸€ç§å®ç°çŠ¶æ€æœºçš„æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•çš„æ ¸å¿ƒæ˜¯åŸºäºè¡¨é©±åŠ¨çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¡¨ä¸­å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€æ˜¯ç”±å½“å‰çŠ¶æ€å’Œè¡Œä¸ºå…±åŒå†³å®šçš„ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨è¡¨ä¸­æŸ¥æ‰¾çŠ¶æ€ï¼Œè€Œä¸å¿…å®šä¹‰å¾ˆå¤šæ¡ä»¶åˆ†æ”¯ï¼Œå¦‚å›¾ 16-6 æ‰€ç¤ºã€‚

| æ¡ä»¶\çŠ¶æ€ | çŠ¶æ€ A | çŠ¶æ€ B | çŠ¶æ€ C |
| --------- | ------ | ------ | ------ |
| æ¡ä»¶ X    | ...    | ...    | ...    |
| æ¡ä»¶ Y    | ...    | çŠ¶æ€ C | ...    |
| æ¡ä»¶ Z    | ...    | ...    | ...    |

å›¾ 16-6

åˆšå¥½ GitHub ä¸Šæœ‰ä¸€ä¸ªå¯¹åº”çš„åº“å®ç°ï¼Œé€šè¿‡è¿™ä¸ªåº“ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°åˆ›å»ºå‡º FSMï¼š

```js
var fsm = StateMachine.create({
  initial: "off",
  events: [
    { name: "buttonWasPressed", from: "off", to: "on" },
    { name: "buttonWasPressed", from: "on", to: "off" },
  ],
  callbacks: {
    onbuttonWasPressed: function (event, from, to) {
      console.log(arguments);
    },
  },
  error: function (eventName, from, to, args, errorCode, errorMessage) {
    console.log(arguments); // ä»ä¸€ç§çŠ¶æ€è¯•å›¾åˆ‡æ¢åˆ°ä¸€ç§ä¸å¯èƒ½åˆ°è¾¾çš„çŠ¶æ€çš„æ—¶å€™
  },
});
button.onclick = function () {
  fsm.buttonWasPressed();
};
```

å…³äºè¿™ä¸ªåº“çš„æ›´å¤šå†…å®¹è¿™é‡Œä¸å†èµ˜è¿°ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‰å¾€ï¼šhttps:// github.com/jakesgordon/javascript-state-machine å­¦ä¹ ã€‚

### 16.11 å®é™…é¡¹ç›®ä¸­çš„å…¶ä»–çŠ¶æ€æœº

åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¾ˆå¤šåœºæ™¯éƒ½å¯ä»¥ç”¨çŠ¶æ€æœºæ¥æ¨¡æ‹Ÿï¼Œ æ¯”å¦‚ä¸€ä¸ªä¸‹æ‹‰èœå•åœ¨ hover åŠ¨ä½œä¸‹æœ‰æ˜¾ç¤ºã€æ‚¬æµ®ã€éšè—ç­‰çŠ¶æ€ï¼›ä¸€æ¬¡ TCP è¯·æ±‚æœ‰å»ºç«‹è¿æ¥ã€ç›‘å¬ã€å…³é—­ç­‰çŠ¶æ€ï¼›ä¸€ä¸ªæ ¼æ–—æ¸¸æˆä¸­äººç‰©æœ‰æ”»å‡»ã€é˜²å¾¡ã€è·³è·ƒã€è·Œå€’ç­‰çŠ¶æ€ã€‚

çŠ¶æ€æœºåœ¨æ¸¸æˆå¼€å‘ä¸­ä¹Ÿæœ‰ç€å¹¿æ³›çš„ç”¨é€”ï¼Œç‰¹åˆ«æ˜¯æ¸¸æˆ AI çš„é€»è¾‘ç¼–å†™ã€‚åœ¨æˆ‘æ›¾ç»å¼€å‘çš„ HTML5 ç‰ˆè¡—å¤´éœ¸ç‹æ¸¸æˆé‡Œï¼Œæ¸¸æˆä¸»è§’ Ryu æœ‰èµ°åŠ¨ã€æ”»å‡»ã€é˜²å¾¡ã€è·Œå€’ã€è·³è·ƒç­‰å¤šç§çŠ¶æ€ã€‚è¿™äº›çŠ¶æ€ä¹‹é—´æ—¢äº’ç›¸è”ç³»åˆäº’ç›¸çº¦æŸã€‚æ¯”å¦‚ Ryu åœ¨èµ°åŠ¨çš„è¿‡ç¨‹ä¸­å¦‚æœè¢«æ”»å‡»ï¼Œå°±ä¼šç”±èµ°åŠ¨çŠ¶æ€åˆ‡æ¢ä¸ºè·Œå€’çŠ¶æ€ã€‚åœ¨è·Œå€’çŠ¶æ€ä¸‹ï¼ŒRyu æ—¢ä¸èƒ½æ”»å‡»ä¹Ÿä¸èƒ½é˜²å¾¡ã€‚åŒæ ·ï¼ŒRyu ä¹Ÿä¸èƒ½åœ¨è·³è·ƒçš„è¿‡ç¨‹ä¸­åˆ‡æ¢åˆ°é˜²å¾¡çŠ¶æ€ï¼Œä½†æ˜¯å¯ä»¥è¿›è¡Œæ”»å‡»ã€‚è¿™ç§åœºæ™¯å°±å¾ˆé€‚åˆç”¨çŠ¶æ€æœºæ¥æè¿°ã€‚ä»£ç å¦‚ä¸‹ï¼š

```js
var FSM = {
  walk: {
    attack: function () {
      console.log("æ”»å‡»");
    },
    defense: function () {
      console.log("é˜²å¾¡");
    },
    jump: function () {
      console.log("è·³è·ƒ");
    },
  },
  attack: {
    walk: function () {
      console.log("æ”»å‡»çš„æ—¶å€™ä¸èƒ½è¡Œèµ°");
    },
    defense: function () {
      console.log("æ”»å‡»çš„æ—¶å€™ä¸èƒ½é˜²å¾¡");
    },
    jump: function () {
      console.log("æ”»å‡»çš„æ—¶å€™ä¸èƒ½è·³è·ƒ");
    },
  },
};
```

### 16.12 å°ç»“

è¿™ä¸€ç« é€šè¿‡å‡ ä¸ªä¾‹å­ï¼Œè®²è§£äº†çŠ¶æ€æ¨¡å¼åœ¨å®é™…å¼€å‘ä¸­çš„åº”ç”¨ã€‚çŠ¶æ€æ¨¡å¼ä¹Ÿè®¸æ˜¯è¢«å¤§å®¶ä½ä¼°çš„æ¨¡å¼ä¹‹ä¸€ã€‚å®é™…ä¸Šï¼Œé€šè¿‡çŠ¶æ€æ¨¡å¼é‡æ„ä»£ç ä¹‹åï¼Œå¾ˆå¤šæ‚ä¹±æ— ç« çš„ä»£ç ä¼šå˜å¾—æ¸…æ™°ã€‚è™½ç„¶çŠ¶æ€æ¨¡å¼ä¸€å¼€å§‹å¹¶ä¸æ˜¯éå¸¸å®¹æ˜“ç†è§£ï¼Œä½†æˆ‘ä»¬æœ‰å¿…é¡»å»å¥½å¥½æŒæ¡è¿™ç§è®¾è®¡æ¨¡å¼ã€‚
